################################################################################
# 1. ConfigMap con scripts de inicialización
################################################################################
apiVersion: v1                    # Versión de la API de Kubernetes para ConfigMap
kind: ConfigMap                   # Tipo de recurso: ConfigMap
metadata:
  name: mysql-init-scripts        # Nombre del ConfigMap, usado para referencia en el Deployment
data:
  init.sql: |                     # Archivo SQL que MySQL ejecuta al iniciarse
    -- Crea la base de datos si no existe
    CREATE DATABASE IF NOT EXISTS toolrentdb;

---

################################################################################
# 2. PersistentVolumeClaim para almacenamiento persistente de MySQL
################################################################################
apiVersion: v1                                  # Versión de la API para PVC
kind: PersistentVolumeClaim                     # Tipo de recurso: PersistentVolumeClaim
metadata:
  name: mysql-pvc                              # Nombre del PVC; debe coincidir con el usado en el Deployment
spec:
  accessModes:
    - ReadWriteOnce                           # Solo un nodo puede montar este volumen en modo escritura/lectura
  resources:
    requests:
      storage: 4Gi                            # Espacio solicitado para la base de datos (puedes ajustar)

---

################################################################################
# 3. Deployment de MySQL con volumen persistente y script de inicialización
################################################################################
apiVersion: apps/v1                            # Versión de la API para Deployment
kind: Deployment                               # Tipo de recurso: Deployment
metadata:
  name: mysql-server                          # Nombre del Deployment
spec:
  selector:
    matchLabels:
      app: mysql                              # Selector usado por el Service y para identificar el Pod
  template:
    metadata:
      labels:
        app: mysql                            # Label para asociar con el Service y selectores
    spec:
      containers:
      - name: mysql                           # Nombre del contenedor
        image: mysql:8.0                      # Imagen oficial de MySQL
        env:
        - name: MYSQL_ROOT_PASSWORD           # Variable de entorno para la contraseña ROOT
          valueFrom:
            secretKeyRef:
              name: db-credentials           # Nombre del Secret (debe existir, no definido aquí)
              key: mysql-root-password       # Key de la password en el Secret
        ports:
        - containerPort: 3306                 # Puerto en el que escucha MySQL dentro del contenedor
        volumeMounts:
        - name: mysql-init
          mountPath: /docker-entrypoint-initdb.d   # Donde montar el SQL de inicialización para MySQL
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql                # Montaje del directorio de datos de MySQL al PVC
      volumes:
      - name: mysql-init
        configMap:
          name: mysql-init-scripts            # Volumen ConfigMap para el script init.sql
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pvc                # El nombre del PVC definido arriba

---

################################################################################
# 4. Service (ClusterIP) para exponer MySQL internamente en el cluster
################################################################################
apiVersion: v1                                    # Versión de la API para Service
kind: Service                                     # Tipo de recurso: Service
metadata:
  name: mysql-service                             # Nombre del Service; se usará como DNS interno
spec:
  selector:
    app: mysql                                    # Asocia el Service a los Pods con label app=mysql
  ports:
    - port: 3306                                  # Puerto desde el cual el Service se expone
      targetPort: 3306                            # Puerto del contenedor MySQL
  type: ClusterIP                                 # Solo accesible desde dentro del cluster (seguro)
